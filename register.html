<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Register - Safhanarizqi Enterprise</title>
  <link rel="stylesheet" href="styles/main.css">
  <style>
    .registration-page {
      max-width: 500px;
      animation: slideUp 0.3s ease-out;
    }

    .password-rules {
      font-size: 0.8em;
      color: var(--gold);
      margin: 5px 0 10px;
      opacity: 0.8;
    }

    .status-message {
      padding: 12px;
      margin: 15px 0;
      border-radius: 5px;
      text-align: center;
      font-size: 14px;
      display: none;
    }

    .status-message.success {
      background: rgba(0, 200, 81, 0.1);
      border: 1px solid #00C851;
      color: #00C851;
      display: block;
    }

    .status-message.error {
      background: rgba(255, 68, 68, 0.1);
      border: 1px solid #ff4444;
      color: #ff4444;
      display: block;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 480px) {
      .registration-page {
        padding: 15px;
      }
      
      input {
        padding: 10px;
        font-size: 14px;
      }
      
      button {
        padding: 10px;
        font-size: 14px;
      }
    }

    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .container {
      flex: 1;
    }

    .button-loader {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid #fff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container registration-page">
    <h1>New Registration</h1>
    
    <div class="input-group">
      <input type="tel" 
             id="regPhone" 
             placeholder="Phone (673/60 format)" 
             pattern="^(673\d{7,}|60\d{9,})$" 
             required>
      <div class="error-message" id="phoneError"></div>
    </div>
    
    <div class="input-group">
      <input type="text" id="icNumber" placeholder="I.C Number" required>
      <div class="error-message" id="icError"></div>
    </div>

    <div class="input-group">
      <label>Front I.C (Image/PDF):</label>
      <input type="file" id="frontIc" accept="image/*,.pdf" required>
      <div class="error-message" id="frontIcError"></div>
    </div>

    <div class="input-group">
      <label>Back I.C (Image/PDF):</label>
      <input type="file" id="backIc" accept="image/*,.pdf" required>
      <div class="error-message" id="backIcError"></div>
    </div>

    <div class="input-group">
      <input type="text" id="fullName" placeholder="Full Name" required>
      <div class="error-message" id="nameError"></div>
    </div>

    <div class="input-group">
      <input type="text" id="address" placeholder="Mailing Address" required>
      <div class="error-message" id="addressError"></div>
    </div>

    <div class="input-group">
      <input type="text" id="postcode" placeholder="Postcode" pattern="\d{5}" required>
      <div class="error-message" id="postcodeError"></div>
    </div>

    <div class="input-group">
      <input type="password" 
             id="regPassword" 
             placeholder="Create Password"
             pattern="^(?=.*[A-Z])(?=.*\d).{6,}$" 
             required>
      <div class="password-rules">6+ characters, 1 uppercase, 1 number</div>
      <div class="error-message" id="passError"></div>
    </div>

    <div class="input-group">
      <input type="password" 
             id="regConfirmPass" 
             placeholder="Confirm Password" 
             required>
      <div class="error-message" id="confirmPassError"></div>
    </div>

    <div class="input-group">
      <input type="email" 
             id="regEmail" 
             placeholder="Email Address" 
             required>
      <div class="error-message" id="emailError"></div>
    </div>

    <div class="input-group">
      <input type="email" 
             id="regConfirmEmail" 
             placeholder="Confirm Email" 
             required>
      <div class="error-message" id="confirmEmailError"></div>
    </div>

    <button onclick="handleRegistration()">Register</button>
    <button class="secondary-btn" onclick="safeRedirect('login.html')" style="margin-top: 10px;">Back to Login</button>

    <div id="registrationStatus" class="status-message"></div>
  </div>

  <script src="scripts/app.js"></script>
  <script>
  async function handleRegistration() {
    const btn = document.querySelector('button');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<div class="button-loader"></div> Registering...';
    clearErrors();

    try {
      console.log('Starting registration process...');
      
      if (!validateRegistrationForm()) {
        console.warn('Form validation failed');
        return;
      }

      const formData = new FormData();
      // Add text fields
      formData.append('action', 'createAccount');
      formData.append('phone', document.getElementById('regPhone').value.trim());
      formData.append('password', document.getElementById('regPassword').value);
      formData.append('email', document.getElementById('regEmail').value.trim());
      formData.append('icNumber', document.getElementById('icNumber').value.trim());
      formData.append('fullName', document.getElementById('fullName').value.trim());
      formData.append('address', document.getElementById('address').value.trim());
      formData.append('postcode', document.getElementById('postcode').value.trim());
      
      // Add files with proper field names
      const frontIcFile = document.getElementById('frontIc').files[0];
      const backIcFile = document.getElementById('backIc').files[0];
      formData.append('frontIc', frontIcFile, frontIcFile.name);
      formData.append('backIc', backIcFile, backIcFile.name);

      console.log('FormData content:', Array.from(formData.entries()));

      const response = await fetch(CONFIG.GAS_URL, {
        method: 'POST',
        body: formData,
        redirect: 'follow' // Important for Google Scripts
      });

      console.log('Received response:', response);

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const result = await response.json();
      console.log('API Result:', result);

      if (result.success) {
        showError('âœ“ Registration successful! Redirecting...', 'registrationStatus');
        setTimeout(() => safeRedirect('login.html'), 1500);
      } else {
        showError(`â— ${result.message || 'Registration failed'}`, 'registrationStatus');
      }
    } catch (error) {
      console.error('Registration error:', error);
      showError(`â— Error: ${error.message}`, 'registrationStatus');
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalText;
      console.log('Registration process completed');
    }
  }

  // Add debug-friendly validation
  function validateRegistrationForm() {
    let isValid = true;
    
    const validateField = (fieldId, validator, errorId) => {
      const element = document.getElementById(fieldId);
      const errorElement = document.getElementById(errorId);
      const valid = validator(element);
      if (!valid) {
        errorElement.textContent = element.validationMessage || 'Invalid value';
        isValid = false;
      }
      return valid;
    };

    // Required field validations
    isValid &= validateField('regPhone', validatePhone, 'phoneError');
    isValid &= validateField('fullName', el => el.value.trim().length >= 3, 'nameError');
    isValid &= validateField('address', el => el.value.trim().length >= 5, 'addressError');
    isValid &= validateField('postcode', el => /^\d{5}$/.test(el.value), 'postcodeError');
    isValid &= validateField('frontIc', el => el.files.length > 0, 'frontIcError');
    isValid &= validateField('backIc', el => el.files.length > 0, 'backIcError');
    isValid &= validateField('regPassword', validatePassword, 'passError');
    isValid &= validateField('regConfirmPass', el => el.value === document.getElementById('regPassword').value, 'confirmPassError');
    isValid &= validateField('regEmail', validateEmail, 'emailError');
    isValid &= validateField('regConfirmEmail', el => el.value === document.getElementById('regEmail').value, 'confirmEmailError');

    console.log('Form validation result:', isValid);
    return isValid;
  }

  // Enhanced validation helpers
  function validatePhone(element) {
    const value = element.value.trim();
    const isValid = /^(673\d{7,}|60\d{9,})$/.test(value);
    element.setCustomValidity(isValid ? '' : 'Invalid phone format');
    return isValid;
  }

  function validatePassword(element) {
    const value = element.value;
    const isValid = /^(?=.*[A-Z])(?=.*\d).{6,}$/.test(value);
    element.setCustomValidity(isValid ? '' : '6+ chars, 1 uppercase, 1 number');
    return isValid;
  }

  function validateEmail(element) {
    const value = element.value.trim();
    const isValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
    element.setCustomValidity(isValid ? '' : 'Invalid email format');
    return isValid;
  }

  // Real-time validation listeners
  document.getElementById('regPhone').addEventListener('input', function() {
    validatePhone(this);
    document.getElementById('phoneError').textContent = this.validationMessage;
  });

  document.getElementById('postcode').addEventListener('input', function() {
    const isValid = /^\d{5}$/.test(this.value);
    this.setCustomValidity(isValid ? '' : '5 digits required');
    document.getElementById('postcodeError').textContent = this.validationMessage;
  });

  document.getElementById('fullName').addEventListener('input', function() {
    const isValid = this.value.trim().length >= 3;
    this.setCustomValidity(isValid ? '' : 'Minimum 3 characters required');
    document.getElementById('nameError').textContent = this.validationMessage;
  });

  document.getElementById('address').addEventListener('input', function() {
    const isValid = this.value.trim().length >= 5;
    this.setCustomValidity(isValid ? '' : 'Minimum 5 characters required');
    document.getElementById('addressError').textContent = this.validationMessage;
  });

  document.getElementById('regPassword').addEventListener('input', function() {
    validatePassword(this);
    document.getElementById('passError').textContent = this.validationMessage;
  });

  document.getElementById('regConfirmPass').addEventListener('input', function() {
    const isValid = this.value === document.getElementById('regPassword').value;
    this.setCustomValidity(isValid ? '' : 'Passwords must match');
    document.getElementById('confirmPassError').textContent = this.validationMessage;
  });

  document.getElementById('regEmail').addEventListener('input', function() {
    validateEmail(this);
    document.getElementById('emailError').textContent = this.validationMessage;
  });

  document.getElementById('regConfirmEmail').addEventListener('input', function() {
    const isValid = this.value === document.getElementById('regEmail').value;
    this.setCustomValidity(isValid ? '' : 'Emails must match');
    document.getElementById('confirmEmailError').textContent = this.validationMessage;
  });

  document.getElementById('frontIc').addEventListener('change', function() {
    const isValid = this.files.length > 0;
    this.setCustomValidity(isValid ? '' : 'Front IC required');
    document.getElementById('frontIcError').textContent = this.validationMessage;
  });

  document.getElementById('backIc').addEventListener('change', function() {
    const isValid = this.files.length > 0;
    this.setCustomValidity(isValid ? '' : 'Back IC required');
    document.getElementById('backIcError').textContent = this.validationMessage;
  });

  function clearErrors() {
    document.querySelectorAll('.error-message').forEach(el => {
      el.textContent = '';
    });
    document.querySelectorAll('input, select').forEach(el => {
      el.setCustomValidity('');
    });
  }
  </script>
  
  <div class="footer-text">
    Built by Omis Logistics. For more info ðŸ‘‰
    <a href="https://wa.me/6737187776" target="_blank" rel="noopener">here</a>
  </div>
</body>
</html>
