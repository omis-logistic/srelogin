<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Register - Safhanarizqi Enterprise</title>
  <link rel="stylesheet" href="styles/main.css">
  <style>
    .registration-page {
      max-width: 500px;
      animation: slideUp 0.3s ease-out;
    }

    .password-rules {
      font-size: 0.8em;
      color: var(--gold);
      margin: 5px 0 10px;
      opacity: 0.8;
    }

    .status-message {
      padding: 12px;
      margin: 15px 0;
      border-radius: 5px;
      text-align: center;
      font-size: 14px;
      display: none;
    }

    .status-message.success {
      background: rgba(0, 200, 81, 0.1);
      border: 1px solid #00C851;
      color: #00C851;
      display: block;
    }

    .status-message.error {
      background: rgba(255, 68, 68, 0.1);
      border: 1px solid #ff4444;
      color: #ff4444;
      display: block;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 480px) {
      .registration-page {
        padding: 15px;
      }
      
      input {
        padding: 10px;
        font-size: 14px;
      }
      
      button {
        padding: 10px;
        font-size: 14px;
      }
    }

    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .container {
      flex: 1;
    }

    .button-loader {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid #fff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container registration-page">
    <h1>New Registration</h1>
    
    <div class="input-group">
      <input type="tel" 
             id="regPhone" 
             placeholder="Phone (673/60 format)" 
             pattern="^(673\d{7,}|60\d{9,})$" 
             required>
      <div class="error-message" id="phoneError"></div>
    </div>
    
    <div class="input-group">
      <input type="text" id="icNumber" placeholder="I.C Number" required>
      <div class="error-message" id="icError"></div>
    </div>

    <div class="input-group">
      <label>Front I.C (Image/PDF):</label>
      <input type="file" id="frontIc" accept="image/*,.pdf" required>
      <div class="error-message" id="frontIcError"></div>
    </div>

    <div class="input-group">
      <label>Back I.C (Image/PDF):</label>
      <input type="file" id="backIc" accept="image/*,.pdf" required>
      <div class="error-message" id="backIcError"></div>
    </div>

    <div class="input-group">
      <input type="text" id="fullName" placeholder="Full Name" required>
      <div class="error-message" id="nameError"></div>
    </div>

    <div class="input-group">
      <input type="text" id="address" placeholder="Mailing Address" required>
      <div class="error-message" id="addressError"></div>
    </div>

    <div class="input-group">
      <input type="text" id="postcode" placeholder="Postcode" pattern="\d{5}" required>
      <div class="error-message" id="postcodeError"></div>
    </div>

    <div class="input-group">
      <input type="password" 
             id="regPassword" 
             placeholder="Create Password"
             pattern="^(?=.*[A-Z])(?=.*\d).{6,}$" 
             required>
      <div class="password-rules">6+ characters, 1 uppercase, 1 number</div>
      <div class="error-message" id="passError"></div>
    </div>

    <div class="input-group">
      <input type="password" 
             id="regConfirmPass" 
             placeholder="Confirm Password" 
             required>
      <div class="error-message" id="confirmPassError"></div>
    </div>

    <div class="input-group">
      <input type="email" 
             id="regEmail" 
             placeholder="Email Address" 
             required>
      <div class="error-message" id="emailError"></div>
    </div>

    <div class="input-group">
      <input type="email" 
             id="regConfirmEmail" 
             placeholder="Confirm Email" 
             required>
      <div class="error-message" id="confirmEmailError"></div>
    </div>

    <button id="registerButton" onclick="handleRegistration()">
  Register
</button>
    <button class="secondary-btn" onclick="safeRedirect('login.html')" style="margin-top: 10px;">Back to Login</button>

    <div id="registrationStatus" class="status-message"></div>
  </div>

  <script src="scripts/app.js"></script>
  <script>
    
  // ================= UPDATED REGISTRATION HANDLER =================
async function handleRegistration() {
  try {
    const btn = document.getElementById('registerButton');
    if (!btn) throw new Error('Register button not found');
    
    const originalBtnText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner"></div> Processing...';

    const formData = new FormData();
    
    // Required fields
    const fields = {
      phone: document.getElementById('regPhone').value.trim(),
      password: document.getElementById('regPassword').value,
      email: document.getElementById('regEmail').value.trim(),
      icNumber: document.getElementById('icNumber').value.trim(),
      fullName: document.getElementById('fullName').value.trim(),
      address: document.getElementById('address').value.trim(),
      postcode: document.getElementById('postcode').value.trim()
    };

    // Validate required fields
    Object.entries(fields).forEach(([key, value]) => {
      if (!value) throw new Error(`Missing ${key.replace('reg', '')}`);
    });

    // Add JSON data
    formData.append('data', JSON.stringify(fields));

    // Add files
    const frontIc = document.getElementById('frontIc').files[0];
    const backIc = document.getElementById('backIc').files[0];
    if (!frontIc || !backIc) throw new Error('Both IC files required');
    
    formData.append('frontIc', frontIc);
    formData.append('backIc', backIc);

    // Send request
    const response = await fetch(CONFIG.PROXY_URL, {
      method: 'POST',
      body: formData
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.message || 'Registration failed');
    }

    const result = await response.json();
    if (result.success) {
      window.location.href = 'login.html';
    } else {
      throw new Error(result.message);
    }

  } catch (error) {
    showError(error.message);
    console.error('Registration Error:', error);
  } finally {
    const btn = document.getElementById('registerButton');
    if (btn) {
      btn.disabled = false;
      btn.innerHTML = 'Register';
    }
  }
}

// Utility functions
function showError(message, targetId = 'registrationStatus') {
  const errorElement = document.getElementById(targetId);
  errorElement.textContent = message;
  errorElement.style.display = 'block';
  errorElement.style.color = message.includes('âœ“') ? '#00C851' : '#ff4444';
  setTimeout(() => errorElement.style.display = 'none', 5000);
}

function showLoading(show = true) {
  const loader = document.getElementById('loadingOverlay');
  loader.style.display = show ? 'flex' : 'none';
}

// ================= FILE PROCESSING UTILITIES =================
async function processFileInput(elementId) {
  const fileInput = document.getElementById(elementId);
  if (!fileInput || !fileInput.files[0]) return null;
  
  try {
    const file = fileInput.files[0];
    return {
      name: file.name,
      type: file.type,
      data: await readFileAsBase64(file)
    };
  } catch (error) {
    console.error('File processing error:', error);
    throw new Error(`Failed to process ${elementId} file`);
  }
}

function readFileAsBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      const result = reader.result;
      if (!result) {
        reject(new Error('Failed to read file'));
        return;
      }
      resolve(result.split(',')[1]); // Remove data URL prefix
    };
    reader.onerror = error => reject(error);
    reader.readAsDataURL(file);
  });
}

// ================= CORRECTED VALIDATION FUNCTIONS =================
function validatePhone(value) {
  const cleanValue = String(value || '').trim().replace(/[^0-9]/g, '');
  return /^(673\d{7,}|60\d{9,})$/.test(cleanValue);
}

function validatePassword(value) {
  return /^(?=.*[A-Z])(?=.*\d).{6,}$/.test(value || '');
}

function validateEmail(value) {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value || '');
}

// ================= COMPLETE VALIDATION MATRIX =================
function validateRegistrationForm() {
  let isValid = true;
  document.querySelectorAll('.error-message').forEach(el => el.textContent = '');

  const validations = [
    { id: 'regPhone', validator: validatePhone, errorId: 'phoneError' },
    { id: 'fullName', validator: v => String(v || '').trim().length >= 3, errorId: 'nameError' },
    { id: 'address', validator: v => String(v || '').trim().length >= 5, errorId: 'addressError' },
    { id: 'postcode', validator: v => /^\d{5}$/.test(v || ''), errorId: 'postcodeError' },
    { id: 'regPassword', validator: validatePassword, errorId: 'passError' },
    { id: 'regConfirmPass', validator: v => v === (document.getElementById('regPassword')?.value || ''), errorId: 'confirmPassError' },
    { id: 'regEmail', validator: validateEmail, errorId: 'emailError' },
    { id: 'regConfirmEmail', validator: v => v === (document.getElementById('regEmail')?.value || ''), errorId: 'confirmEmailError' }
  ];

  validations.forEach(({ id, validator, errorId }) => {
    const value = document.getElementById(id)?.value || '';
    const valid = validator(value);
    if (!valid) {
      document.getElementById(errorId).textContent = getValidationMessage(id);
      isValid = false;
    }
  });

  // File validation
  ['frontIc', 'backIc'].forEach(id => {
    const fileInput = document.getElementById(id);
    if (!fileInput?.files?.[0]) {
      document.getElementById(`${id}Error`).textContent = `${id.replace('Ic', ' IC')} is required`;
      isValid = false;
    }
  });

  return isValid;
}

// ================= VALIDATION MESSAGES =================
function getValidationMessage(fieldId) {
  const messages = {
    regPhone: 'Valid phone number required (673/60 format)',
    fullName: 'Minimum 3 characters required',
    address: 'Minimum 5 characters required',
    postcode: '5-digit postcode required',
    regPassword: '6+ characters with 1 uppercase and 1 number',
    regConfirmPass: 'Passwords must match',
    regEmail: 'Valid email required',
    regConfirmEmail: 'Emails must match'
  };
  return messages[fieldId] || 'Invalid value';
}

// ================= UPDATED REAL-TIME VALIDATION =================
document.getElementById('regPhone').addEventListener('input', function() {
  const isValid = validatePhone(this.value);
  this.setCustomValidity(isValid ? '' : 'Invalid format');
  document.getElementById('phoneError').textContent = isValid ? '' : getValidationMessage('regPhone');
});

document.getElementById('fullName').addEventListener('input', function() {
  const isValid = this.value.trim().length >= 3;
  this.setCustomValidity(isValid ? '' : 'Too short');
  document.getElementById('nameError').textContent = isValid ? '' : getValidationMessage('fullName');
});

document.getElementById('address').addEventListener('input', function() {
  const isValid = this.value.trim().length >= 5;
  this.setCustomValidity(isValid ? '' : 'Too short');
  document.getElementById('addressError').textContent = isValid ? '' : getValidationMessage('address');
});

document.getElementById('postcode').addEventListener('input', function() {
  const isValid = /^\d{5}$/.test(this.value);
  this.setCustomValidity(isValid ? '' : 'Invalid postcode');
  document.getElementById('postcodeError').textContent = isValid ? '' : getValidationMessage('postcode');
});

document.getElementById('regPassword').addEventListener('input', function() {
  const isValid = validatePassword(this.value);
  this.setCustomValidity(isValid ? '' : 'Invalid format');
  document.getElementById('passError').textContent = isValid ? '' : getValidationMessage('regPassword');
});

document.getElementById('regConfirmPass').addEventListener('input', function() {
  const isValid = this.value === document.getElementById('regPassword').value;
  this.setCustomValidity(isValid ? '' : 'Mismatch');
  document.getElementById('confirmPassError').textContent = isValid ? '' : getValidationMessage('regConfirmPass');
});

document.getElementById('regEmail').addEventListener('input', function() {
  const isValid = validateEmail(this.value);
  this.setCustomValidity(isValid ? '' : 'Invalid email');
  document.getElementById('emailError').textContent = isValid ? '' : getValidationMessage('regEmail');
});

document.getElementById('regConfirmEmail').addEventListener('input', function() {
  const isValid = this.value === document.getElementById('regEmail').value;
  this.setCustomValidity(isValid ? '' : 'Mismatch');
  document.getElementById('confirmEmailError').textContent = isValid ? '' : getValidationMessage('regConfirmEmail');
});

document.getElementById('frontIc').addEventListener('change', function() {
  const isValid = this.files.length > 0;
  this.setCustomValidity(isValid ? '' : 'Required');
  document.getElementById('frontIcError').textContent = isValid ? '' : getValidationMessage('frontIc');
});

document.getElementById('backIc').addEventListener('change', function() {
  const isValid = this.files.length > 0;
  this.setCustomValidity(isValid ? '' : 'Required');
  document.getElementById('backIcError').textContent = isValid ? '' : getValidationMessage('backIc');
});

// ================= UTILITIES =================
function clearErrors() {
  document.querySelectorAll('.error-message').forEach(el => {
    el.textContent = '';
  });
  document.querySelectorAll('input').forEach(el => {
    el.setCustomValidity('');
  });
}

  </script>
  
  <div class="footer-text">
    Built by Omis Logistics. For more info ðŸ‘‰
    <a href="https://wa.me/6737187776" target="_blank" rel="noopener">here</a>
  </div>
</body>
</html>
