<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Registration - Safhanarizqi Enterprise</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles/main.css">
  <style>
    .registration-page {
      max-width: 600px;
      margin: 2rem auto;
      padding: 1.5rem;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(197, 160, 71, 0.3);
    }

    .input-group {
      margin-bottom: 1.5rem;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--gold);
    }

    input, select, textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--gold);
      border-radius: 5px;
      background: #333;
      color: #fff;
      font-size: 16px;
    }

    .file-input {
      border: 2px dashed var(--gold);
      padding: 1rem;
      text-align: center;
    }

    .button-group {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
    }

    button {
      background: var(--gold);
      color: #000;
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      transition: opacity 0.3s;
    }

    button:hover {
      opacity: 0.9;
    }

    .error-message {
      color: #ff4444;
      font-size: 0.9rem;
      margin-top: 0.25rem;
      display: none;
    }

    .status-message {
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 5px;
      text-align: center;
      display: none;
    }

    .status-message.success {
      background: rgba(0, 200, 81, 0.1);
      border: 1px solid #00C851;
      color: #00C851;
    }

    .status-message.error {
      background: rgba(255, 68, 68, 0.1);
      border: 1px solid #ff4444;
      color: #ff4444;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="registration-page">
      <h1>New Account Registration</h1>
      
      <form id="registrationForm" enctype="multipart/form-data">
        <!-- Phone Number -->
        <div class="input-group">
          <label for="regPhone">Phone Number (673/60 format)</label>
          <input type="tel" id="regPhone" name="regPhone" pattern="^(673\d{7,}|60\d{9,})$" required>
          <div class="error-message" id="phoneError"></div>
        </div>

        <!-- IC Number -->
        <div class="input-group">
          <label for="icNumber">I.C Number</label>
          <input type="text" id="icNumber" name="icNumber" required>
          <div class="error-message" id="icError"></div>
        </div>

        <!-- IC Documents -->
        <div class="input-group">
          <label>Identity Documents</label>
          <div class="file-input">
            <label for="frontIc">Front IC (Image/PDF)</label>
            <input type="file" id="frontIc" name="frontIc" accept="image/*,.pdf" required>
            <div class="error-message" id="frontIcError"></div>
          </div>
          <div class="file-input">
            <label for="backIc">Back IC (Image/PDF)</label>
            <input type="file" id="backIc" name="backIc" accept="image/*,.pdf" required>
            <div class="error-message" id="backIcError"></div>
          </div>
        </div>

        <!-- Personal Details -->
        <div class="input-group">
          <label for="fullName">Full Name</label>
          <input type="text" id="fullName" name="fullName" required>
          <div class="error-message" id="nameError"></div>
        </div>

        <div class="input-group">
          <label for="address">Mailing Address</label>
          <textarea id="address" name="address" required></textarea>
          <div class="error-message" id="addressError"></div>
        </div>

        <div class="input-group">
          <label for="postcode">Postcode</label>
          <input type="text" id="postcode" name="postcode" pattern="\d{5}" required>
          <div class="error-message" id="postcodeError"></div>
        </div>

        <!-- Account Details -->
        <div class="input-group">
          <label for="regPassword">Password</label>
          <input type="password" id="regPassword" name="regPassword" required>
          <div class="error-message" id="passError"></div>
        </div>

        <div class="input-group">
          <label for="regConfirmPass">Confirm Password</label>
          <input type="password" id="regConfirmPass" name="regConfirmPass" required>
          <div class="error-message" id="confirmPassError"></div>
        </div>

        <div class="input-group">
          <label for="regEmail">Email Address</label>
          <input type="email" id="regEmail" name="regEmail" required>
          <div class="error-message" id="emailError"></div>
        </div>

        <div class="input-group">
          <label for="regConfirmEmail">Confirm Email</label>
          <input type="email" id="regConfirmEmail" name="regConfirmEmail" required>
          <div class="error-message" id="confirmEmailError"></div>
        </div>

        <!-- Form Actions -->
        <div class="button-group">
          <button type="button" onclick="handleRegistration()">Register</button>
          <button type="button" class="secondary-btn" onclick="safeRedirect('login.html')">
            Back to Login
          </button>
        </div>

        <!-- Status Messages -->
        <div id="registrationStatus" class="status-message"></div>
      </form>
    </div>
  </div>

  <script>
    const CONFIG = {
      PROXY_URL: 'https://script.google.com/macros/s/AKfycbzUZudt9i78uO1dBSjahNdTqETk4_WXJ5RWG2BnqqZKxrRRgkuA88rcVjhUft0e1AOV/exec'
    };

    // ================= UPDATED REGISTRATION HANDLER =================
    async function handleRegistration() {
  const btn = document.querySelector('#registrationForm button[type="button"]');
  const originalBtnHTML = btn.innerHTML;
  const statusElement = document.getElementById('registrationStatus');
  const form = document.getElementById('registrationForm');

  try {
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner"></div> Processing...';
    statusElement.style.display = 'none';

    if (!validateRegistrationForm()) {
      showStatus('Please fix form errors', 'error');
      return;
    }

    const formData = new FormData(form);
    const frontIcInput = document.getElementById('frontIc');
    const backIcInput = document.getElementById('backIc');

    // Validate files directly from input elements
    if (!frontIcInput.files[0]) throw new Error('Front IC document is required');
    if (!backIcInput.files[0]) throw new Error('Back IC document is required');

    const payload = {
  action: 'createAccount',
  phone: (formData.get('regPhone') || '').trim(),
  password: formData.get('regPassword') || '',
  email: (formData.get('regEmail') || '').trim(),
  icNumber: (formData.get('icNumber') || '').trim(),
  fullName: (formData.get('fullName') || '').trim(),
  address: (formData.get('address') || '').trim(),
  postcode: (formData.get('postcode') || '').trim(),
  timestamp: new Date().toISOString()
};

    const submissionData = new FormData(form);
    submissionData.append('data', JSON.stringify(payload));

    const response = await fetch(CONFIG.PROXY_URL, {
      method: 'POST',
      body: submissionData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    });

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`Server error: ${response.status} - ${errorText}`);
    }

    const result = await response.json();

    if (!result.success) {
      throw new Error(result.message || 'Registration failed on server');
    }

    showStatus('Registration successful! Redirecting...', 'success');
    setTimeout(() => safeRedirect('login.html'), 2000);

  } catch (error) {
    console.error('Registration Error:', error);
    const errorMessage = error.message.includes('Failed to fetch') 
      ? 'Network error - check internet connection'
      : error.message;

    showStatus(`Error: ${errorMessage}`, 'error');
    form.querySelectorAll('input, button').forEach(el => el.disabled = false);

  } finally {
    btn.disabled = false;
    btn.innerHTML = originalBtnHTML;
  }
}

    // ================= VALIDATION FUNCTIONS =================
    function validateRegistrationForm() {
  let isValid = true;
  document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');

  // Phone validation
  const phone = document.getElementById('regPhone').value.trim();
  if (!/^(673\d{7,}|60\d{9,})$/.test(phone)) {
    showError('phoneError', 'Invalid phone format (673/60 prefix required)');
    isValid = false;
  }

  // IC Number validation
  const icNumber = document.getElementById('icNumber').value.trim();
  if (!icNumber) {
    showError('icError', 'IC number is required');
    isValid = false;
  }

  // Full Name validation
  const fullName = document.getElementById('fullName').value.trim();
  if (fullName.length < 3) {
    showError('nameError', 'Minimum 3 characters required');
    isValid = false;
  }

  // Address validation
  const address = document.getElementById('address').value.trim();
  if (address.length < 5) {
    showError('addressError', 'Minimum 5 characters required');
    isValid = false;
  }

  // Postcode validation
  const postcode = document.getElementById('postcode').value.trim();
  if (!/^\d{5}$/.test(postcode)) {
    showError('postcodeError', '5-digit postcode required');
    isValid = false;
  }

  // Password validation
  const password = document.getElementById('regPassword').value;
  if (!/(?=.*[A-Z])(?=.*\d).{6,}/.test(password)) {
    showError('passError', '6+ characters with 1 uppercase & 1 number');
    isValid = false;
  }

  // Confirm Password validation
  const confirmPassword = document.getElementById('regConfirmPass').value;
  if (password !== confirmPassword) {
    showError('confirmPassError', 'Passwords do not match');
    isValid = false;
  }

  // Email validation
  const email = document.getElementById('regEmail').value.trim();
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    showError('emailError', 'Invalid email format');
    isValid = false;
  }

  // Confirm Email validation
  const confirmEmail = document.getElementById('regConfirmEmail').value.trim();
  if (email !== confirmEmail) {
    showError('confirmEmailError', 'Emails do not match');
    isValid = false;
  }

  // Front IC validation
  const frontIc = document.getElementById('frontIc').files;
  if (!frontIc || frontIc.length === 0) {
    showError('frontIcError', 'Front IC document required');
    isValid = false;
  }

  // Back IC validation
  const backIc = document.getElementById('backIc').files;
  if (!backIc || backIc.length === 0) {
    showError('backIcError', 'Back IC document required');
    isValid = false;
  }

  // File type validation
  if (frontIc.length > 0) {
    const frontFile = frontIc[0];
    if (!['image/jpeg', 'image/png', 'application/pdf'].includes(frontFile.type)) {
      showError('frontIcError', 'Invalid file type (JPEG/PNG/PDF only)');
      isValid = false;
    }
  }

  if (backIc.length > 0) {
    const backFile = backIc[0];
    if (!['image/jpeg', 'image/png', 'application/pdf'].includes(backFile.type)) {
      showError('backIcError', 'Invalid file type (JPEG/PNG/PDF only)');
      isValid = false;
    }
  }

  return isValid;
}

// Helper function to display errors
function showError(elementId, message) {
  const errorElement = document.getElementById(elementId);
  if (errorElement) {
    errorElement.textContent = message;
    errorElement.style.display = 'block';
  }
}

    function showStatus(message, type = 'info') {
  const statusElement = document.getElementById('registrationStatus');
  statusElement.textContent = message;
  statusElement.className = `status-message ${type}`;
  statusElement.style.display = 'block';
  
  // Auto-hide success messages
  if (type === 'success') {
    setTimeout(() => {
      statusElement.style.display = 'none';
    }, 5000);
  }
}

    function clearErrors() {
      document.querySelectorAll('.error-message').forEach(el => {
        el.textContent = '';
        el.style.display = 'none';
      });
      document.getElementById('registrationStatus').style.display = 'none';
    }

    function safeRedirect(path) {
      window.location.href = path;
    }

    // Initialize real-time validations
    document.querySelectorAll('input, select').forEach(element => {
      element.addEventListener('input', () => {
        if (element.checkValidity) {
          const errorId = `${element.id}Error`;
          element.reportValidity();
          document.getElementById(errorId).style.display = 
            element.validity.valid ? 'none' : 'block';
        }
      });
    });
  </script>

  <div class="footer-text">
    Built by Omis Logistics. For more info 👉
    <a href="https://wa.me/6737187776" target="_blank" rel="noopener">here</a>
  </div>
</body>
</html>
