<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Registration - Safhanarizqi Enterprise</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles/main.css">
  <style>
    .registration-page {
      max-width: 600px;
      margin: 2rem auto;
      padding: 1.5rem;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(197, 160, 71, 0.3);
    }

    .input-group {
      margin-bottom: 1.5rem;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--gold);
    }

    input, select, textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--gold);
      border-radius: 5px;
      background: #333;
      color: #fff;
      font-size: 16px;
    }

    .file-input {
      border: 2px dashed var(--gold);
      padding: 1rem;
      text-align: center;
    }

    .button-group {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
    }

    button {
      background: var(--gold);
      color: #000;
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      transition: opacity 0.3s;
    }

    button:hover {
      opacity: 0.9;
    }

    .error-message {
      color: #ff4444;
      font-size: 0.9rem;
      margin-top: 0.25rem;
      display: none;
    }

    .status-message {
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 5px;
      text-align: center;
      display: none;
    }

    .status-message.success {
      background: rgba(0, 200, 81, 0.1);
      border: 1px solid #00C851;
      color: #00C851;
    }

    .status-message.error {
      background: rgba(255, 68, 68, 0.1);
      border: 1px solid #ff4444;
      color: #ff4444;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="registration-page">
      <h1>New Account Registration</h1>
      
      <form id="registrationForm" enctype="multipart/form-data">
        <!-- Phone Number -->
        <div class="input-group">
          <label for="regPhone">Phone Number (673/60 format)</label>
          <input type="tel" id="regPhone" pattern="^(673\d{7,}|60\d{9,})$" required>
          <div class="error-message" id="phoneError"></div>
        </div>

        <!-- IC Number -->
        <div class="input-group">
          <label for="icNumber">I.C Number</label>
          <input type="text" id="icNumber" required>
          <div class="error-message" id="icError"></div>
        </div>

        <!-- IC Documents -->
        <div class="input-group">
          <label>Identity Documents</label>
          <div class="file-input">
            <label for="frontIc">Front IC (Image/PDF)</label>
            <input type="file" id="frontIc" accept="image/*,.pdf" required>
            <div class="error-message" id="frontIcError"></div>
          </div>
          <div class="file-input">
            <label for="backIc">Back IC (Image/PDF)</label>
            <input type="file" id="backIc" accept="image/*,.pdf" required>
            <div class="error-message" id="backIcError"></div>
          </div>
        </div>

        <!-- Personal Details -->
        <div class="input-group">
          <label for="fullName">Full Name</label>
          <input type="text" id="fullName" required>
          <div class="error-message" id="nameError"></div>
        </div>

        <div class="input-group">
          <label for="address">Mailing Address</label>
          <textarea id="address" required></textarea>
          <div class="error-message" id="addressError"></div>
        </div>

        <div class="input-group">
          <label for="postcode">Postcode</label>
          <input type="text" id="postcode" pattern="\d{5}" required>
          <div class="error-message" id="postcodeError"></div>
        </div>

        <!-- Account Details -->
        <div class="input-group">
          <label for="regPassword">Password</label>
          <input type="password" id="regPassword" 
                 pattern="^(?=.*[A-Z])(?=.*\d).{6,}$" required>
          <div class="error-message" id="passError"></div>
        </div>

        <div class="input-group">
          <label for="regConfirmPass">Confirm Password</label>
          <input type="password" id="regConfirmPass" required>
          <div class="error-message" id="confirmPassError"></div>
        </div>

        <div class="input-group">
          <label for="regEmail">Email Address</label>
          <input type="email" id="regEmail" required>
          <div class="error-message" id="emailError"></div>
        </div>

        <div class="input-group">
          <label for="regConfirmEmail">Confirm Email</label>
          <input type="email" id="regConfirmEmail" required>
          <div class="error-message" id="confirmEmailError"></div>
        </div>

        <!-- Form Actions -->
        <div class="button-group">
          <button type="button" onclick="handleRegistration()">Register</button>
          <button type="button" class="secondary-btn" onclick="safeRedirect('login.html')">
            Back to Login
          </button>
        </div>

        <!-- Status Messages -->
        <div id="registrationStatus" class="status-message"></div>
      </form>
    </div>
  </div>

  <script>
    const CONFIG = {
      PROXY_URL: 'https://script.google.com/macros/s/AKfycbxIAX4irDMGRGzrQcnuQIP3-gAdMJ_tdAP9UDHr14s4deFBLu_-RjBRjZA8FgX3mrqtEQ/exec'
    };

    // ================= UPDATED REGISTRATION HANDLER =================
    async function handleRegistration() {
      const btn = document.querySelector('button');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<div class="button-loader"></div> Registering...';
      clearErrors();

      try {
        if (!validateRegistrationForm()) return;

        const formData = new FormData();
        
        // Append all form fields
        formData.append('action', 'createAccount');
        formData.append('phone', document.getElementById('regPhone').value.trim());
        formData.append('password', document.getElementById('regPassword').value);
        formData.append('email', document.getElementById('regEmail').value.trim());
        formData.append('icNumber', document.getElementById('icNumber').value.trim());
        formData.append('fullName', document.getElementById('fullName').value.trim());
        formData.append('address', document.getElementById('address').value.trim());
        formData.append('postcode', document.getElementById('postcode').value.trim());

        // Append files
        const frontIcFile = document.getElementById('frontIc').files[0];
        const backIcFile = document.getElementById('backIc').files[0];
        formData.append('frontIc', frontIcFile);
        formData.append('backIc', backIcFile);

        const response = await fetch(CONFIG.PROXY_URL, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        
        const result = await response.json();
        
        if (result.success) {
          showStatus('✓ Registration successful! Redirecting...', 'success');
          setTimeout(() => safeRedirect('login.html'), 1500);
        } else {
          showStatus(`❗ ${result.message || 'Registration failed'}`, 'error');
        }
      } catch (error) {
        console.error('Registration error:', error);
        showStatus(`❗ Error: ${error.message}`, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    // ================= VALIDATION FUNCTIONS =================
    function validateRegistrationForm() {
      let isValid = true;
      clearErrors();

      // Phone Validation
      const phone = document.getElementById('regPhone').value;
      if (!/^(673\d{7,}|60\d{9,})$/.test(phone)) {
        showError('phoneError', 'Invalid phone format');
        isValid = false;
      }

      // IC Validation
      if (!document.getElementById('icNumber').value.trim()) {
        showError('icError', 'IC number required');
        isValid = false;
      }

      // Name Validation
      const fullName = document.getElementById('fullName').value;
      if (fullName.trim().length < 3) {
        showError('nameError', 'Minimum 3 characters');
        isValid = false;
      }

      // Address Validation
      if (document.getElementById('address').value.trim().length < 5) {
        showError('addressError', 'Minimum 5 characters');
        isValid = false;
      }

      // Postcode Validation
      if (!/^\d{5}$/.test(document.getElementById('postcode').value)) {
        showError('postcodeError', '5-digit postcode required');
        isValid = false;
      }

      // Password Validation
      const password = document.getElementById('regPassword').value;
      if (!/(?=.*[A-Z])(?=.*\d).{6,}/.test(password)) {
        showError('passError', '6+ chars with 1 uppercase & 1 number');
        isValid = false;
      }

      // Password Match
      if (password !== document.getElementById('regConfirmPass').value) {
        showError('confirmPassError', 'Passwords do not match');
        isValid = false;
      }

      // Email Validation
      const email = document.getElementById('regEmail').value;
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        showError('emailError', 'Invalid email format');
        isValid = false;
      }

      // Email Match
      if (email !== document.getElementById('regConfirmEmail').value) {
        showError('confirmEmailError', 'Emails do not match');
        isValid = false;
      }

      // File Validation
      if (!document.getElementById('frontIc').files[0]) {
        showError('frontIcError', 'Front IC required');
        isValid = false;
      }
      if (!document.getElementById('backIc').files[0]) {
        showError('backIcError', 'Back IC required');
        isValid = false;
      }

      return isValid;
    }

    // ================= UTILITY FUNCTIONS =================
    function showError(elementId, message) {
      const element = document.getElementById(elementId);
      if (element) {
        element.textContent = message;
        element.style.display = 'block';
      }
    }

    function showStatus(message, type = 'info') {
      const statusElement = document.getElementById('registrationStatus');
      statusElement.textContent = message;
      statusElement.className = `status-message ${type}`;
      statusElement.style.display = 'block';
    }

    function clearErrors() {
      document.querySelectorAll('.error-message').forEach(el => {
        el.textContent = '';
        el.style.display = 'none';
      });
      document.getElementById('registrationStatus').style.display = 'none';
    }

    function safeRedirect(path) {
      window.location.href = path;
    }

    // Initialize real-time validations
    document.querySelectorAll('input, select').forEach(element => {
      element.addEventListener('input', () => {
        if (element.checkValidity) {
          const errorId = `${element.id}Error`;
          element.reportValidity();
          document.getElementById(errorId).style.display = 
            element.validity.valid ? 'none' : 'block';
        }
      });
    });
  </script>

  <div class="footer-text">
    Built by Omis Logistics. For more info 👉
    <a href="https://wa.me/6737187776" target="_blank" rel="noopener">here</a>
  </div>
</body>
</html>
